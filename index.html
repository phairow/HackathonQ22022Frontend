<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <meta charset="utf-8">

    <title>Hackathon Q2 2022</title>

    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/index.css?v=0.0.1">

    <script src="/static/pubnub.js?v=5.0.1"></script>
    <script src="/static/jquery.js?v=3.6.0"></script>
    <script src="/static/pixi.js?v=6.2.2"></script>
    <script src="/game/game.js?v=0.0.1"></script>
    <script src="/game/leaderboard.js"></script>
  </head>
  <body>
    <h1 id="heading">Hackathon Q2 2022 <span id="game-instance"></span></h1>
    <div id="login-container" class="container">
      <div id="login-view" class="fixed">
        <form action="javascript:() => false;">
          Player:
          <input id="username" type="text"/>
          <button type="submit" onclick="login();">Start Game</button>
        </form>
      </div>
      <div id="loggedin-view" class="fixed" style="display:none";>
        Player: <span id="loggedin-user"></span>
        <button type="submit" onclick="logout();">Leave Game</button>
      </div>
    </div>
    <div class="container">
      <div id="game-container" class="container flex-item" style="display:none;">
        <div id="game-view" class="fixed"></div>
        <div id="leaderboard-container" class="container-column flex-item">
          Ranking
          <div id="leaderboard-view" class="flex-item"></div>
        </div>
      </div>
      <div id="leaderboard-global-container" class="container-column flex-item">
        All Time Ranking
        <div id="leaderboard-global-view" class="flex-item"></div>
      </div>
    </div>
    <script>
      let gameInstanceId = `Q2_2022_game_id_${Date.now()}`;
      let gameChannel = `scores-${gameInstanceId}`;
      let leaderboardChannel = `leaderboard-${gameInstanceId}-points`;
      let leaderboardGlobalChannel = `leaderboard-points`;
      let publishKey = 'myPublishKey';
      let uuid = '__UUID__';
      let subscribeKey = 'mySubscribeKey';
      let loginView = $('#login-view');
      let loggedinView = $('#loggedin-view');
      let loggedinUser= $('#loggedin-user');
      let gameContainer = $('#game-container');
      let gameView = $('#game-view');
      let leaderboardView = $('#leaderboard-view');
      let leaderboardGlobalView = $('#leaderboard-global-view');
      let gameInstanceView = $('#game-instance');
      let userNameTextBox = $('#username');

      gameInstanceView.text(`(${gameInstanceId})`);

      let pubnub = new PubNub({
        publishKey,
        subscribeKey,
        uuid,
      });

      let game = new Game();
      let leaderboard = new Leaderboard();
      let leaderboardGlobal = new Leaderboard();

      leaderboardGlobal.start(leaderboardGlobalView, gameInstanceId, uuid, pubnub, leaderboardGlobalChannel);

      function login() {
        let username = userNameTextBox.val();

        if (username.length < 1) {
          alert('Player name required');
        } else {
          startGame(username);
        }
      }

      function logout() {
        userNameTextBox.val('');

        stopGame();
      }

      function startGame(uuid) {
        loginView.hide();
        loggedinView.fadeIn();
        gameContainer.fadeIn();

        loggedinUser.text(uuid);

        game.start(gameView, gameInstanceId, uuid, pubnub, gameChannel);
        leaderboard.start(leaderboardView, leaderboardGlobalView, gameInstanceId, uuid, pubnub, leaderboardChannel);
      }

      function stopGame() {
        loginView.fadeIn();
        loggedinView.hide();
        gameContainer.hide();
        game.stop();
      }

    </script>
  </body>
</html>