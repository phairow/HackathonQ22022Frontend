<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <meta charset="utf-8">

    <title>Hackathon Q2 2022</title>

    <link rel="icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/index.css?v=0.0.1">

    <script src="/static/pubnub.js?v=5.0.1"></script>
    <script src="/static/jquery.js?v=3.6.0"></script>
    <script src="/static/pixi.js?v=6.2.2"></script>
    <script src="/game/game.js?v=0.0.1"></script>
    <script src="/game/leaderboard.js"></script>
  </head>
  <body>
    <h1 id="heading">
      Hackathon Q2 2022
      <span id="game-instance"></span>
      <button onclick="shareGame();" class="share-button">
        <img class="share-icon" src="/game/share.png" />
      </button>
      <span style="display:none;font-size:12px;" class="share-message">Copied to clipboard!</span>
    </h1>
    <div id="login-container" class="container">
      <div id="login-view" class="fixed">
        <form action="javascript:() => false;">
          Player: 
          <input autofocus="autofocus" id="username" type="text"/>
          <button type="submit" onclick="login();">Start Game</button>
        </form>
      </div>
      <div id="loggedin-view" class="fixed" style="display:none";>
        Player: <span id="loggedin-user"></span>
        <button type="submit" onclick="logout();">Leave Game</button>
      </div>
    </div>
    <div class="container">
      <div id="game-container" class="container flex-item" style="display:none;">
        <div class="container-column fixed">
          <div class="flex-item">Use 	&#8592; and &#8594; to move and space bar to fire missiles &#128640;</div>
          <div id="game-view" class="flex-item"></div>
        </div>
        <div id="leaderboard-container" class="container-column flex-item">
          Current Game Ranking
          <div id="leaderboard-view" class="flex-item"></div>
        </div>
      </div>
      <div id="leaderboard-global-container" class="container-column flex-item">
        All Time Ranking
        <div id="leaderboard-global-view" class="flex-item"></div>
      </div>
    </div>
    <script>
      let game = new Game();
      let leaderboard = new Leaderboard();
      let leaderboardGlobal = new Leaderboard();
      let gameInstanceId = '';
      let query = new URLSearchParams(window.location.search);
      
      if (query.has('gameInstanceId')) {
        gameInstanceId = query.get('gameInstanceId');
      } else {
        gameInstanceId = `Q2_2022_game_id_${Date.now()}`;
      }

      let gameChannel = `scores-${gameInstanceId}`;
      let leaderboardChannel = `leaderboard-${gameInstanceId}-points`;
      let leaderboardGlobalChannel = `leaderboard-points`;
      let publishKey = 'pub-c-f076d9c1-172d-479e-8bcd-c7aa591f0752';
      let subscribeKey = 'sub-c-b6721214-9a5f-11ec-8d33-deca9b9b34c5';
      let uuid = '__UUID__';
      let loginView = $('#login-view');
      let loggedinView = $('#loggedin-view');
      let loggedinUser= $('#loggedin-user');
      let gameContainer = $('#game-container');
      let gameView = $('#game-view');
      let leaderboardView = $('#leaderboard-view');
      let leaderboardGlobalView = $('#leaderboard-global-view');
      let gameInstanceView = $('#game-instance');
      let userNameTextBox = $('#username');

      gameInstanceView.text(`(${gameInstanceId})`);

      let pubnub = new PubNub({
        publishKey,
        subscribeKey,
        uuid,
        origin: "ingress-tcp-pub.pdx1.aws.int.ps.pn",
      });

      pubnub.addListener({
        message: (m) => {
          if (m.channel === gameChannel) {
            console.log('game channel:', m.message)
          }

          if (m.channel === leaderboardChannel) {
            console.log('leaderboard channel:', m.message)
            leaderboard.setLeaders(m.message.leaders);
          }

          if (m.channel === leaderboardGlobalChannel) {
            console.log('leaderboard global channel:', m.message)
            leaderboardGlobal.setLeaders(m.message.leaders);
          }
        }
      });

      pubnub.subscribe({
        channels: [
          leaderboardChannel,
          leaderboardGlobalChannel,
          gameChannel
        ]
      });

      let leaders = [
        {
            'playerId': '8e8047ff-666b-4435-b3f0-3cc571eace62',
            'score': 0.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': 'b1070140-5eae-45e0-bca3-ff9c1b93dd01',
            'score': 11.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': '7123e6ea-1efa-4cda-95f3-72ef1467a04b',
            'score': 23.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': '3207fd3e-14c2-46d7-b672-736cbb8380f4',
            'score': 20.0,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': 'ab58b1c3-45c8-4a2a-971e-c5be741a9b42',
            'score': 13.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': 'rai',
            'score': 3.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': '0f4421c3-a99d-4fa9-a5be-da96051f6b57',
            'score': 2.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': 'john',
            'score': 5.0,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': '8ecdb2cf-fd2f-4488-84df-0b1c5a656e9f',
            'score': 213.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        },
        {
            'playerId': 'drew',
            'score': 33.5,
            'gameInstanceId': 'bd1d4463-e995-4f5b-ba77-61aac21f9f3b'
        }
      ];
      
      pubnub.publish({
        channel: leaderboardChannel,
        message: {
          gameInstanceId,
          leaders
        }
      });
      
      pubnub.publish({
        channel: leaderboardGlobalChannel,
        message: {
          gameInstanceId,
          leaders
        }
      });

setTimeout(() => {
  leaderboardGlobal.start(leaderboardGlobalView, gameInstanceId, uuid, pubnub, leaderboardGlobalChannel);
}, 1000);
      

      function login() {
        let username = userNameTextBox.val();

        if (username.length < 1) {
          alert('Player name required');
        } else {
          startGame(username);
        }
      }

      function logout() {
        userNameTextBox.val('');

        stopGame();
      }

      function startGame(uuid) {
        loginView.hide();
        loggedinView.fadeIn();
        gameContainer.fadeIn();

        loggedinUser.text(uuid);

        game.start(gameView, gameInstanceId, uuid, pubnub, gameChannel);
        leaderboard.start(leaderboardView, leaderboardGlobalView, gameInstanceId, uuid, pubnub, leaderboardChannel);
      }

      function stopGame() {
        loginView.fadeIn();
        loggedinView.hide();
        gameContainer.hide();
        game.stop();
      }

      function shareGame() {
        let link = 'https://optimistic-mcnulty-65517e.netlify.app?gameInstanceId=' + gameInstanceId;
        var data = [new ClipboardItem({ "text/plain": new Blob([link], { type: "text/plain" }) })];
        navigator.clipboard.write(data).then(function() {
          $('.share-message').fadeIn(500).fadeOut(2000);
        }, function() {
          alert("Unable to write to clipboard. :-(");
        });
      }

    </script>
  </body>
</html>